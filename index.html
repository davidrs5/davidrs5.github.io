<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<style>
    .chart rect {
        fill: steelblue
    }
</style>
<html>
<head>
    <title>MPG Rating or CO2 output 1984-2021</title>
    <h2>Has the average rating or co2 decreased over time, depending on cylinders?</h2>
</head>
      
<body onload='init()'>
    <form>
        <fieldset>
          <legend># of Cylinders:</legend>
          <div>
            <input type="radio" id="c4" name="cylinders" value="4"  onchange="set_cylinder(4)" checked="checked"/>
            <label for="c4">4</label>
            <input type="radio" id="c6" name="cylinders" value="6"  onchange="set_cylinder(6)"/>
            <label for="c6">6</label>
            <input type="radio" id="c8" name="cylinders" value="8"  onchange="set_cylinder(8)"/>
            <label for="c8">8</label>
            <input type="radio" id="c10" name="cylinders" value="10"  onchange="set_cylinder(10)"/>
            <label for="c10">10</label>
          </div>
        </fieldset>
      </form>
    <div id='graph_area'></div>
    <script>
        var axy1 = {};
        axy1[4]=[300,90,0,200];
        axy1[6]=[300,185,0,105];
        axy1[8]=[300,265,0,25];
        axy1[10]=[310,295,100,0];
        var car_cylinders = {};
        current_cylinder_num = 4;
        const margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = 460 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;
        async function init() {
            svg = d3.select("#graph_area")
            // set the dimensions and margins of the graph
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            const car_data = await d3.csv('https://davidrs5.github.io/cars.csv');
            for (let i = 0; i < car_data.length; i++) {
                c = car_data[i].cylinders
                if (!(c in car_cylinders)) {
                    car_cylinders[c] = [];
                }
                car_cylinders[c].push(car_data[i])
            }
            const cafe_data = await d3.csv('https://davidrs5.github.io/cafe.csv');
            set_cylinder(4);
        }

        function set_cylinder(num) {
            current_cylinder_num = num
            // clear
            // d3.select("#graph_area").html=""
            svg.selectAll("*").remove();
            // svg.html=""
            const x = d3.scaleLinear()
                .domain([1984,2025])
                .range([0, width]);
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x).tickFormat(d3.format("d")));

            // Add Y axis
            const y = d3.scaleLinear()
                .domain([10, 30])
                .range([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(y));

            // Add the line
            svg.append("path")
                .datum(car_cylinders[current_cylinder_num])
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function (d) { return x(parseInt(d.year,10)) })
                    .y(function (d) { return y(parseInt(d.mpg,10)) })
                )
            svg.append("path")
                .datum(cafe_data)
                .attr("fill", "none")
                .attr("stroke", "green")
                .attr("stroke-width", 2.5)
                .attr("d", d3.line()
                    .x(function (d) { return x(parseInt(d.year,10)) })
                    .y(function (d) { return y(parseInt(d.num,10)) })
                )
            d3.select(".annotations").remove()
            annotations = 
            [{
                note: {
                        label: "Obama CAFE Implemented",
                        title: "2011"
                },
                id: "1",
                // If you don't provide a custom "type" attribute in your options dictionary, , 
                // the default type in the getAnnotations function will be used.
                data: car_cylinders[current_cylinder_num],
                x:axy1[current_cylinder_num][0],
                y:axy1[current_cylinder_num][1],
                dx: axy1[current_cylinder_num][2], 
                dy: axy1[current_cylinder_num][3] 
            }]    
            var makeAnnotations = d3.annotation()
                .editMode(true)
                //also can set and override in the note.padding property
                //of the annotation object
                .notePadding(15)
                .type(d3.annotationLabel)
                .annotations(annotations)
            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations)
        }
        
        </script>
    
</body>

</html>